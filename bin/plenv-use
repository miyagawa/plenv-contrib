#!/usr/bin/env bash
#
# Summary: Launches a new shell with specified perl and/or local::lib path
#
# Usage: plenv use perl-version@lib
#        plenv use perl-version
#        plenv use @lib
#
# Launches a new shell with specified perl version. When the '@lib' part is
# specified, the local::lib name created with plenv lib is also activated.
#
# When the perl version is empty, the current perl version is used.

resolve_name () {

    local name=$1

    local sIFS=$IFS
    IFS='|'
    read perl_ver lib_name < <(perl -e "\$,=q[|]; print split /@/, q[$name], 2" )
    IFS="$sIFS"

    test -z "$perl_ver" && perl_ver="$(plenv version-name)"

    if ! plenv prefix "$perl_ver" > /dev/null ; then
	exit 1
    fi

    export PLENV_VERSION="$perl_ver"

    if [ -n "$lib_name" ]; then
	local lib=$PLENV_VERSION@$lib_name
	local local_lib=$PLENV_ROOT/libs/$lib

	if [ ! -d $local_lib ] ; then
	    echo "lib $lib doesn't exist. Create it first with 'plenv lib create $lib'" >&2
	    exit 1
	fi

	export PLENV_USE_LIB="$lib_name"
    fi

}

perl_with_lib=$1

if [ -z "$perl_with_lib" ] ; then
    echo "Usage: plenv use perl-version[\@lib]" >&2
    exit 1
fi

resolve_name "$perl_with_lib"

echo -ne "\nA sub-shell is launched with PLENV_VERSION=$PLENV_VERSION"
test -n "$PLENV_USE_LIB" && echo -n " and PLENV_USE_LIB=$PLENV_USE_LIB"
echo -e ". Run 'exit' to finish it.\n\n";

exec "$SHELL"
